<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pannetjes – Zelftest</title>
    <style>
        :root{
            --bg:#bdcef0; --card:#121a2b; --muted:#9aa4b2; --text:#eaf0ff; --accent:#6ea8fe; --accent-2:#9bdbff;
            --ok:#30c48d; --warn:#ffb020; --err:#ff6b6b;
        }
        *{box-sizing:border-box}
        html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"}
        a{color:var(--accent)}
        .wrap{max-width:860px;margin:24px auto;padding:16px}
        .card{background:var(--card);border-radius:20px;padding:20px;box-shadow:0 6px 30px rgba(0,0,0,.25);margin-bottom:16px}
        h1{font-size:1.6rem;margin:0 0 8px}
        h2{font-size:1.1rem;margin:0 0 8px}
        p{margin:0 0 8px;color:var(--muted)}
        .q{display:grid;gap:10px}
        .opts{display:grid;gap:8px;margin-top:4px}
        .opt{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.03);}
        .opt input{transform:translateY(2px);min-width:20px;min-height:20px}
        .foot{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;margin-top:10px}
        .score{font-weight:600}
        .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.06);color:var(--muted);font-size:.9rem}
        .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
        .result{display:grid;gap:10px}
        .big{font-size:2.3rem;font-weight:800;letter-spacing:.5px}
        .btn{appearance:none;border:0;border-radius:14px;padding:10px 14px;background:rgba(255,255,255,.1);color:var(--text);font-weight:600}
        .btn:hover{background:rgba(255,255,255,.15);cursor:pointer}
        .note{color:var(--muted);font-size:.95rem}
        .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
        .grid-2{display:grid;gap:12px}
        @media(min-width:720px){ .grid-2{grid-template-columns:1fr 1fr} }
        .muted{color:var(--muted)}

        /* Stijl voor de geschiedenissectie */
        .history-section {
            display: grid;
            gap: 10px;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 14px;
            padding: 10px;
        }

        .history-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        /* Laadindicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="card">
            <h1>Pannetjes – Zelftest</h1>
            <p>Vul de vragen in. De score &ldquo;Pannetje&rdquo; wordt automatisch berekend op basis van je keuzes (zoals in je Excel). De data wordt veilig opgeslagen in een online database, zodat je deze op elk apparaat kunt bekijken en exporteren.</p>
            <p class="note">Tip: op je telefoon kun je deze pagina aan je beginscherm toevoegen om hem als app te gebruiken.</p>
        </div>

        <form id="form" class="grid-2">
            <!-- Vraag 1 -->
            <section class="card q" data-qid="q1" data-type="single-sum">
                <div class="row">
                    <h2>Vraag 1: Wat is je gevoel?</h2>
                    <span class="badge"><span>Score:</span><strong class="score" data-score>–</strong></span>
                </div>
                <div class="opts">
                    <label class="opt"><input type="radio" name="q1" value="Prima" data-weight="1"> Prima</label>
                    <label class="opt"><input type="radio" name="q1" value="Stil" data-weight="4"> Stil</label>
                    <label class="opt"><input type="radio" name="q1" value="Huilerig" data-weight="5"> Huilerig</label>
                </div>
                <div class="foot"><span class="note">1 keuze</span></div>
            </section>

            <!-- Vraag 2 -->
            <section class="card q" data-qid="q2" data-type="avg-ceil">
                <div class="row">
                    <h2>Vraag 2: Lichamelijke sensaties</h2>
                    <span class="badge"><span>Score:</span><strong class="score" data-score>–</strong></span>
                </div>
                <div class="opts">
                    <label class="opt"><input type="checkbox" name="q2" value="Geen" data-weight="1"> Geen</label>
                    <label class="opt"><input type="checkbox" name="q2" value="Ogen vallen beetje dicht" data-weight="3"> Ogen vallen beetje dicht</label>
                    <label class="opt"><input type="checkbox" name="q2" value="Ogen vallen bijna dicht" data-weight="4"> Ogen vallen bijna dicht</label>
                    <label class="opt"><input type="checkbox" name="q2" value="Buikpijn" data-weight="4"> Buikpijn</label>
                    <label class="opt"><input type="checkbox" name="q2" value="Duizelig" data-weight="4"> Duizelig</label>
                    <label class="opt"><input type="checkbox" name="q2" value="Staren" data-weight="5"> Staren</label>
                    <label class="opt"><input type="checkbox" name="q2" value="keelpijn" data-weight="5"> keelpijn</label>
                    <label class="opt"><input type="checkbox" name="q2" value="Ziek" data-weight="5"> Ziek</label>
                </div>
                <div class="foot"><span class="note">Meerdere keuzes toegestaan • Score = afgeronde bovengrens van het gemiddelde</span></div>
            </section>

            <!-- Vraag 3 -->
            <section class="card q" data-qid="q3" data-type="single-sum">
                <div class="row">
                    <h2>Vraag 3: Gedachtes</h2>
                    <span class="badge"><span>Score:</span><strong class="score" data-score>–</strong></span>
                </div>
                <div class="opts">
                    <label class="opt"><input type="radio" name="q3" value="Veel gedachtes" data-weight="1"> Veel gedachtes</label>
                    <label class="opt"><input type="radio" name="q3" value="Minder gedachtes" data-weight="4"> Minder gedachtes</label>
                    <label class="opt"><input type="radio" name="q3" value="Afwezig" data-weight="5"> Afwezig</label>
                </div>
                <div class="foot"><span class="note">1 keuze</span></div>
            </section>

            <!-- Vraag 4 -->
            <section class="card q" data-qid="q4" data-type="special-q4">
                <div class="row">
                    <h2>Vraag 4: Neiging om te doen</h2>
                    <span class="badge"><span>Score:</span><strong class="score" data-score>–</strong></span>
                </div>
                <div class="opts">
                    <label class="opt"><input type="checkbox" name="q4" value="Doorgaan" data-weight="0"> Doorgaan</label>
                    <label class="opt"><input type="checkbox" name="q4" value="Chillen" data-weight="3"> Chillen</label>
                    <label class="opt"><input type="checkbox" name="q4" value="Slapen" data-weight="5"> Slapen</label>
                </div>
                <div class="foot"><span class="note">Meerdere keuzes toegestaan • Speciale weging zoals in Excel</span></div>
                <p class="note muted" data-q4-hint style="display:none">Let op: De combinatie die je koos bestaat niet in het Excel-wegingsmodel. Pas je keuze aan (bijv. kies <em>Doorgaan</em>, of <em>Chillen + Doorgaan</em>, of <em>Slapen</em>, of <em>Chillen + Slapen</em>, of alle drie).</p>
            </section>
        </form>

        <section class="card result">
            <div class="row">
                <h2>Uitkomst</h2>
                <div class="flex gap-2">
                    <button class="btn" id="save-btn" type="button">Test opslaan</button>
                    <button class="btn" id="reset" type="button">Alles wissen</button>
                </div>
            </div>
            <div class="row">
                <div>
                    <div class="note">Totaalscore (gemiddelde van 4 vragen)</div>
                    <div class="big" id="total">–</div>
                </div>
                <div>
                    <div class="note">Pannetje</div>
                    <div class="big" id="pannetje">–</div>
                </div>
            </div>
            <p class="note">Berekening: <code>(Q1 + Q2 + Q3 + Q4) / 4</code>, afgerond naar boven voor het pannetje.</p>
        </section>

        <!-- Nieuwe sectie voor geschiedenis en exporteren -->
        <section class="card history-section">
            <div class="row">
                <h2>Geschiedenis van zelftests</h2>
                <button class="btn" id="export-history-btn">Exporteer naar Excel</button>
            </div>
            <!-- Lijst om de geschiedenis op te slaan -->
            <div id="history-list" class="history-list">
                <p class="muted" id="no-history-text">Nog geen opgeslagen tests.</p>
            </div>
        </section>

        <div class="card">
            <h2>Over de berekening</h2>
            <ul class="note">
                <li><strong>Q1 &amp; Q3</strong>: 1 keuze, score = gewicht van de gekozen optie (zoals je Excel de som van één keuze maakte).</li>
                <li><strong>Q2</strong>: meerdere keuzes; score = gemiddelde van gewichten, naar boven afgerond (<em>ROUNDUP(AVERAGEIF(...))</em> in Excel).</li>
                <li><strong>Q4</strong>: speciale logica: <code>s = som van gewichten</code>, <code>c = aantal keuzes</code>, <code>d = s - 2*c</code>. Daarna een mapping: <code>-2→1</code>, <code>-1→2</code>, <code>2→3</code>, <code>4→4</code>, <code>3→5</code>. Andere waarden worden gemeld als ongeldige combinatie (zoals Excel geen resultaat zou geven).</li>
            </ul>
        </div>
    </div>
    
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>Aan het laden...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs, deleteDoc, doc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Globale variabelen van de omgeving
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, isAuthReady = false;

        const loadingOverlay = document.getElementById('loading-overlay');
        const showLoading = (show) => {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        };

        // Initialiseer Firebase en log de gebruiker in
        showLoading(true);
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                showLoading(false);
                setupRealtimeListener();
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth error:", error);
                    showLoading(false);
                }
            }
        });

        // Setup real-time listener for Firestore data
        function setupRealtimeListener() {
            if (isAuthReady && userId) {
                const historyCollection = collection(db, `artifacts/${appId}/users/${userId}/tests`);
                const q = query(historyCollection);
                onSnapshot(q, (snapshot) => {
                    const history = [];
                    snapshot.forEach(doc => {
                        history.push(doc.data());
                    });
                    displayHistory(history);
                }, (error) => {
                    console.error("Firestore real-time listener failed: ", error);
                });
            }
        }

        const q4Map = new Map([[-2, 1], [-1, 2], [2, 3], [4, 4], [3, 5]]);

        function computeQuestion(section) {
            const type = section.dataset.type;
            const inputs = [...section.querySelectorAll('input')];
            const sel = inputs.filter(i => i.checked);
            const weights = sel.map(i => Number(i.dataset.weight));
            let score = null;

            if (type === 'single-sum') {
                if (sel.length === 0) score = null;
                else score = weights.reduce((a, b) => a + b, 0);
            } else if (type === 'avg-ceil') {
                if (weights.length === 0) score = null;
                else score = Math.ceil(weights.reduce((a, b) => a + b, 0) / weights.length);
            } else if (type === 'special-q4') {
                const hint = section.querySelector('[data-q4-hint]');
                if (weights.length === 0) {
                    score = null;
                    hint.style.display = 'none';
                } else {
                    const s = weights.reduce((a, b) => a + b, 0);
                    const c = weights.length;
                    const d = s - 2 * c;
                    if (q4Map.has(d)) {
                        score = q4Map.get(d);
                        hint.style.display = 'none';
                    } else {
                        score = null;
                        hint.style.display = '';
                    }
                }
            }
            section.querySelector('[data-score]').textContent = (score == null ? '–' : String(score));
            return score;
        }

        function computeAll() {
            const sections = [...document.querySelectorAll('section.q')];
            const scores = sections.map(computeQuestion);
            const valid = scores.filter(s => typeof s === 'number');
            const totalEl = document.getElementById('total');
            const panEl = document.getElementById('pannetje');

            const allAnswered = valid.length === sections.length;

            if (!allAnswered) {
                totalEl.textContent = '–';
                panEl.textContent = '–';
                return null;
            }

            const avg = valid.reduce((a, b) => a + b, 0) / valid.length;
            totalEl.textContent = avg.toFixed(2);
            const pannetje = Math.ceil(avg);
            panEl.textContent = pannetje;

            return pannetje;
        }

        function getAnswers() {
            const answers = {};
            const qSections = document.querySelectorAll('section.q');
            qSections.forEach(section => {
                const qid = section.dataset.qid;
                const questionTitle = section.querySelector('h2').textContent.trim();
                const selectedAnswers = [];
                section.querySelectorAll('input:checked').forEach(input => {
                    selectedAnswers.push(input.value);
                });
                answers[qid] = {
                    title: questionTitle,
                    selected: selectedAnswers
                };
            });
            return answers;
        }

        async function saveCurrentTest() {
            const pannetjeScore = computeAll();
            if (pannetjeScore === null || !isAuthReady) {
                alert('Beantwoord eerst alle vragen.');
                return;
            }

            showLoading(true);
            try {
                const historyCollection = collection(db, `artifacts/${appId}/users/${userId}/tests`);
                const now = new Date();
                const newEntry = {
                    timestamp: now.toISOString(),
                    date: now.toLocaleDateString('nl-NL'),
                    time: now.toLocaleTimeString('nl-NL'),
                    answers: getAnswers(),
                    score: pannetjeScore
                };
                await addDoc(historyCollection, newEntry);

                // Verwijder alle selecties na het opslaan
                document.querySelectorAll('input').forEach(i => i.checked = false);
                computeAll();
            } catch (error) {
                console.error("Fout bij het opslaan van de test: ", error);
                alert("Er is een fout opgetreden bij het opslaan van je test. Probeer het opnieuw.");
            } finally {
                showLoading(false);
            }
        }

        function displayHistory(history) {
            const historyList = document.getElementById('history-list');
            const noHistoryText = document.getElementById('no-history-text');
            const sortedHistory = history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (sortedHistory.length === 0) {
                if (noHistoryText) noHistoryText.style.display = 'block';
                historyList.innerHTML = `<p class="muted" id="no-history-text">Nog geen opgeslagen tests.</p>`;
            } else {
                if (noHistoryText) noHistoryText.style.display = 'none';
                historyList.innerHTML = '';
                sortedHistory.forEach((entry) => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    const answersText = Object.keys(entry.answers).map(qid => {
                        const answer = entry.answers[qid].selected.join(' & ');
                        return answer ? `<strong>${qid.toUpperCase()}:</strong> ${answer}` : null;
                    }).filter(Boolean).join(' | ');

                    item.innerHTML = `
                        <div class="row">
                            <span class="muted">${entry.date} ${entry.time}</span>
                            <span class="badge">
                                <span>Pannetje:</span>
                                <strong>${entry.score}</strong>
                            </span>
                        </div>
                        <div class="note mt-1">
                            ${answersText}
                        </div>
                    `;
                    historyList.appendChild(item);
                });
            }
        }

        async function exportHistory() {
            if (!isAuthReady) {
                alert("Authenticatie is nog niet voltooid. Probeer het over een paar seconden opnieuw.");
                return;
            }

            showLoading(true);
            try {
                const historyCollection = collection(db, `artifacts/${appId}/users/${userId}/tests`);
                const querySnapshot = await getDocs(query(historyCollection));
                const history = [];
                querySnapshot.forEach(doc => {
                    history.push(doc.data());
                });

                if (history.length === 0) {
                    alert('Er is geen geschiedenis om te exporteren.');
                    return;
                }

                const headers = ["Datum", "Tijd", "Pannetje Score", "Q1 Gevoel", "Q2 Lichamelijke sensaties", "Q3 Gedachtes", "Q4 Neiging om te doen"];
                let csvContent = headers.map(h => `"${h}"`).join(";") + "\n";

                history.forEach(entry => {
                    const row = [
                        `"${entry.date}"`,
                        `"${entry.time}"`,
                        `"${entry.score}"`,
                        `"${entry.answers['q1'].selected.join(', ')}"`,
                        `"${entry.answers['q2'].selected.join(', ')}"`,
                        `"${entry.answers['q3'].selected.join(', ')}"`,
                        `"${entry.answers['q4'].selected.join(', ')}"`
                    ];
                    csvContent += row.join(";") + "\n";
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'pannetjes_geschiedenis.csv';
                link.click();
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error("Fout bij het exporteren van de geschiedenis: ", error);
                alert("Er is een fout opgetreden bij het exporteren. Probeer het opnieuw.");
            } finally {
                showLoading(false);
            }
        }

        async function resetAll() {
            if (!isAuthReady) {
                alert("Authenticatie is nog niet voltooid. Probeer het over een paar seconden opnieuw.");
                return;
            }

            showLoading(true);
            try {
                const historyCollection = collection(db, `artifacts/${appId}/users/${userId}/tests`);
                const querySnapshot = await getDocs(query(historyCollection));
                const deletePromises = [];
                querySnapshot.forEach((docRef) => {
                    deletePromises.push(deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/tests`, docRef.id)));
                });
                await Promise.all(deletePromises);

                document.querySelectorAll('input').forEach(i => i.checked = false);
                computeAll();
            } catch (error) {
                console.error("Fout bij het resetten van de gegevens: ", error);
                alert("Er is een fout opgetreden bij het wissen van de gegevens. Probeer het opnieuw.");
            } finally {
                showLoading(false);
            }
        }
        
        document.getElementById('form').addEventListener('change', computeAll);
        document.getElementById('save-btn').addEventListener('click', saveCurrentTest);
        document.getElementById('reset').addEventListener('click', resetAll);
        document.getElementById('export-history-btn').addEventListener('click', exportHistory);
    </script>
</body>
</html>
